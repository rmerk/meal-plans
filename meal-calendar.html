<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#d4735e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Meal Plan Calendar - Meal Plans</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="mobile-utils.js"></script>
    <link rel="stylesheet" href="/dark-mode.css">
    <link rel="stylesheet" href="/landscape.css">
    <style>
        body { font-family: 'Inter', sans-serif; }

        :root {
            --terracotta: #d4735e;
            --terracotta-dark: #b85c47;
            --warm-orange: #e88d67;
        }

        .bg-terracotta { background-color: var(--terracotta); }
        .text-terracotta { color: var(--terracotta); }
        .border-terracotta { border-color: var(--terracotta); }

        .hero-gradient {
            background: linear-gradient(135deg, #d4735e 0%, #e88d67 50%, #ffa07a 100%);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        button, a, input, label {
            touch-action: manipulation;
        }

        .calendar-day {
            min-height: 120px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .meal-chip {
            transition: all 0.2s ease;
            cursor: grab;
        }

        .meal-chip:active {
            cursor: grabbing;
        }

        .meal-chip.dragging {
            opacity: 0.5;
        }

        .calendar-day.drag-over {
            background: rgba(212, 115, 94, 0.1);
            border-color: var(--terracotta);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .week-day-header {
            position: sticky;
            top: 64px;
            z-index: 10;
        }
    </style>
    <script src="meals/plans.js"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-rose-50 min-h-screen antialiased">

    <!-- Header -->
    <header class="hero-gradient shadow-xl relative overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <div class="inline-block mb-4">
                    <span class="text-5xl">üìÖ</span>
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight mb-3">
                    Meal Plan Calendar
                </h1>
                <p class="text-xl text-white/95 max-w-2xl mx-auto mb-6 font-light">
                    Schedule your meals ‚Ä¢ Drag & drop to plan ‚Ä¢ Export to Google Calendar
                </p>
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold rounded-xl transition-all duration-200 border-2 border-white/40">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
                <path d="M0 0L60 8C120 16 240 32 360 37.3C480 43 600 37 720 34.7C840 32 960 32 1080 37.3C1200 43 1320 53 1380 58.7L1440 64V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V0Z" fill="#fef7f5" fill-opacity="0.9"/>
            </svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Controls -->
        <div class="bg-white shadow-xl rounded-2xl p-6 mb-8 border-2 border-orange-100 fade-in">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="previousWeek()" class="p-2 rounded-lg hover:bg-slate-100 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div>
                        <h2 id="week-title" class="text-2xl font-bold text-slate-800"></h2>
                        <p id="date-range" class="text-sm text-slate-600"></p>
                    </div>
                    <button onclick="nextWeek()" class="p-2 rounded-lg hover:bg-slate-100 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    <button onclick="goToToday()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-rose-500 text-white rounded-lg hover:shadow-lg transition text-sm font-semibold">
                        Today
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportToGoogleCalendar()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:shadow-lg transition text-sm font-semibold flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Export
                    </button>
                    <button onclick="copyWeek()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition text-sm font-semibold flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Copy Week
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden border-2 border-orange-100">
            <!-- Day Headers -->
            <div class="grid grid-cols-7 gap-px bg-slate-200 week-day-header">
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Sunday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Monday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Tuesday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Wednesday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Thursday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Friday</div>
                <div class="bg-white p-3 text-center font-bold text-slate-700 text-sm">Saturday</div>
            </div>

            <!-- Calendar Days -->
            <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-slate-200">
                <!-- Days will be generated dynamically -->
            </div>
        </div>

        <!-- Meal Bank -->
        <div class="mt-8 bg-white shadow-xl rounded-2xl p-6 border-2 border-orange-100">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                <span class="text-2xl mr-2">üçΩÔ∏è</span>
                Available Meals
                <span class="ml-3 text-sm font-normal text-slate-500">(Drag to calendar)</span>
            </h3>
            <div id="meal-bank" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <!-- Meal chips will be generated dynamically -->
            </div>
        </div>

    </main>

    <footer class="text-center text-slate-400 text-sm py-8 mt-12">
        <p>Meal Plan Calendar ‚Ä¢ Auto-saves your schedule</p>
    </footer>

    <script>
        const CALENDAR_KEY = 'meal_plan_calendar';
        let currentWeekStart = new Date();

        // Get Monday of the current week
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Initialize to current week starting Monday
        currentWeekStart = getWeekStart(new Date());
        currentWeekStart.setHours(0, 0, 0, 0);

        // Load calendar data
        function loadCalendar() {
            const saved = localStorage.getItem(CALENDAR_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        // Save calendar data
        function saveCalendar(calendar) {
            localStorage.setItem(CALENDAR_KEY, JSON.stringify(calendar));
        }

        // Format date as YYYY-MM-DD
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Get meals for a specific date
        function getMealsForDate(date) {
            const calendar = loadCalendar();
            const dateKey = formatDate(date);
            return calendar[dateKey] || { breakfast: null, lunch: null, dinner: null };
        }

        // Set meal for a date
        function setMealForDate(date, mealType, mealData) {
            const calendar = loadCalendar();
            const dateKey = formatDate(date);

            if (!calendar[dateKey]) {
                calendar[dateKey] = { breakfast: null, lunch: null, dinner: null };
            }

            calendar[dateKey][mealType] = mealData;
            saveCalendar(calendar);
        }

        // Remove meal from a date
        function removeMealFromDate(date, mealType) {
            setMealForDate(date, mealType, null);
        }

        // Navigation functions
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderCalendar();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderCalendar();
        }

        function goToToday() {
            currentWeekStart = getWeekStart(new Date());
            renderCalendar();
        }

        // Copy current week to next week
        function copyWeek() {
            if (!confirm('Copy this week\'s meals to next week?')) return;

            const calendar = loadCalendar();
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);

            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(currentWeekStart);
                currentDate.setDate(currentDate.getDate() + i);
                const currentKey = formatDate(currentDate);

                const nextDate = new Date(nextWeekStart);
                nextDate.setDate(nextDate.getDate() + i);
                const nextKey = formatDate(nextDate);

                if (calendar[currentKey]) {
                    calendar[nextKey] = JSON.parse(JSON.stringify(calendar[currentKey]));
                }
            }

            saveCalendar(calendar);
            nextWeek();
        }

        // Export to Google Calendar (generate .ics file)
        function exportToGoogleCalendar() {
            const calendar = loadCalendar();
            let icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Meal Plans//Calendar//EN\n';

            Object.entries(calendar).forEach(([dateStr, meals]) => {
                const date = new Date(dateStr);
                const dateFormatted = dateStr.replace(/-/g, '');

                ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                    if (meals[mealType]) {
                        const mealName = meals[mealType].name;
                        const timeMap = { breakfast: '0800', lunch: '1200', dinner: '1800' };
                        const time = timeMap[mealType];

                        icsContent += 'BEGIN:VEVENT\n';
                        icsContent += `DTSTART:${dateFormatted}T${time}00\n`;
                        icsContent += `SUMMARY:${mealType.charAt(0).toUpperCase() + mealType.slice(1)}: ${mealName}\n`;
                        icsContent += 'END:VEVENT\n';
                    }
                });
            });

            icsContent += 'END:VCALENDAR';

            // Download .ics file
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal-plan.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Render calendar
        function renderCalendar() {
            updateWeekTitle();
            renderCalendarGrid();
            renderMealBank();
        }

        // Update week title and date range
        function updateWeekTitle() {
            const endOfWeek = new Date(currentWeekStart);
            endOfWeek.setDate(endOfWeek.getDate() + 6);

            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            const startStr = currentWeekStart.toLocaleDateString('en-US', options);
            const endStr = endOfWeek.toLocaleDateString('en-US', options);

            document.getElementById('week-title').textContent = `Week of ${currentWeekStart.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
            document.getElementById('date-range').textContent = `${startStr} - ${endStr}`;
        }

        // Render calendar grid
        function renderCalendarGrid() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const meals = getMealsForDate(date);
                const isToday = formatDate(date) === formatDate(new Date());

                const dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day bg-white p-4 border-2 ${isToday ? 'border-terracotta bg-orange-50' : 'border-transparent'}`;
                dayDiv.dataset.date = formatDate(date);

                dayDiv.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="text-2xl font-bold text-slate-800">${date.getDate()}</div>
                        ${isToday ? '<div class="text-xs text-terracotta font-semibold">TODAY</div>' : ''}
                    </div>
                    <div class="space-y-2" data-meal-container="${formatDate(date)}">
                        ${renderMealSlot(meals.breakfast, 'breakfast', date)}
                        ${renderMealSlot(meals.lunch, 'lunch', date)}
                        ${renderMealSlot(meals.dinner, 'dinner', date)}
                    </div>
                `;

                // Make droppable
                dayDiv.addEventListener('dragover', handleDragOver);
                dayDiv.addEventListener('dragleave', handleDragLeave);
                dayDiv.addEventListener('drop', handleDrop);

                grid.appendChild(dayDiv);
            }
        }

        // Render individual meal slot
        function renderMealSlot(meal, mealType, date) {
            const icons = { breakfast: 'üç≥', lunch: 'ü•ó', dinner: 'üçΩÔ∏è' };
            const labels = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner' };

            if (meal) {
                return `
                    <div class="meal-chip bg-gradient-to-r from-terracotta to-warm-orange text-white px-3 py-2 rounded-lg text-xs font-semibold flex items-center justify-between group"
                        data-meal-type="${mealType}"
                        data-date="${formatDate(date)}">
                        <span>${icons[mealType]} ${meal.name}</span>
                        <button onclick="removeMeal('${formatDate(date)}', '${mealType}')" class="opacity-0 group-hover:opacity-100 transition ml-2 hover:bg-white/20 rounded p-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
            } else {
                return `
                    <div class="meal-slot border-2 border-dashed border-slate-300 px-3 py-2 rounded-lg text-xs text-slate-400 text-center"
                        data-meal-type="${mealType}"
                        data-date="${formatDate(date)}">
                        ${icons[mealType]} ${labels[mealType]}
                    </div>
                `;
            }
        }

        // Render meal bank
        function renderMealBank() {
            const bank = document.getElementById('meal-bank');
            bank.innerHTML = '';

            // Sample meals - in production, this would come from mealPlans
            const sampleMeals = [
                { id: 'teriyaki-chicken', name: 'Teriyaki Chicken', type: 'dinner' },
                { id: 'beef-broccoli', name: 'Beef & Broccoli', type: 'dinner' },
                { id: 'pork-fried-rice', name: 'Pork Fried Rice', type: 'dinner' },
                { id: 'greek-yogurt', name: 'Greek Yogurt Bowl', type: 'breakfast' },
                { id: 'protein-oats', name: 'Protein Oats', type: 'breakfast' },
                { id: 'chicken-salad', name: 'Chicken Salad', type: 'lunch' },
                { id: 'quinoa-bowl', name: 'Quinoa Bowl', type: 'lunch' },
                { id: 'salmon-veggies', name: 'Salmon & Veggies', type: 'dinner' },
            ];

            sampleMeals.forEach(meal => {
                const chip = document.createElement('div');
                chip.className = 'meal-chip bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 text-slate-700 px-4 py-3 rounded-lg text-sm font-semibold text-center cursor-grab shadow-sm hover:shadow-md transition';
                chip.draggable = true;
                chip.dataset.mealId = meal.id;
                chip.dataset.mealName = meal.name;
                chip.dataset.mealType = meal.type;
                chip.textContent = meal.name;

                chip.addEventListener('dragstart', handleDragStart);
                chip.addEventListener('dragend', handleDragEnd);

                bank.appendChild(chip);
            });
        }

        // Drag and drop handlers
        let draggedMeal = null;

        function handleDragStart(e) {
            draggedMeal = {
                id: e.target.dataset.mealId,
                name: e.target.dataset.mealName,
                type: e.target.dataset.mealType
            };
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedMeal) return;

            const date = new Date(e.currentTarget.dataset.date);
            const mealType = draggedMeal.type;

            setMealForDate(date, mealType, {
                id: draggedMeal.id,
                name: draggedMeal.name
            });

            renderCalendar();
        }

        // Remove meal
        function removeMeal(dateStr, mealType) {
            const date = new Date(dateStr);
            removeMealFromDate(date, mealType);
            renderCalendar();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
        });
    </script>

    <!-- Dark Mode Toggle Button -->
    <button
        id="dark-mode-toggle"
        onclick="toggleDarkMode()"
        class="fixed top-4 right-4 z-[100] w-12 h-12 rounded-full bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group border-2 border-transparent hover:border-orange-400"
        aria-label="Toggle dark mode"
        title="Toggle dark mode"
    >
        <svg
            class="w-6 h-6 text-yellow-500 dark-mode-icon-sun hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
        </svg>
        <svg
            class="w-6 h-6 text-slate-700 dark-mode-icon-moon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
        </svg>
    </button>

</body>
</html>
