<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#d4735e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nutrition Dashboard - Meal Plans</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="mobile-utils.js"></script>
    <link rel="stylesheet" href="/dark-mode.css">
    <link rel="stylesheet" href="/landscape.css">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Custom terracotta/orange color palette */
        :root {
            --terracotta: #d4735e;
            --terracotta-dark: #b85c47;
            --warm-orange: #e88d67;
        }

        .bg-terracotta { background-color: var(--terracotta); }
        .text-terracotta { color: var(--terracotta); }
        .border-terracotta { border-color: var(--terracotta); }

        .hero-gradient {
            background: linear-gradient(135deg, #d4735e 0%, #e88d67 50%, #ffa07a 100%);
        }

        /* Mobile optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        button, a, input, label {
            touch-action: manipulation;
        }

        /* Safe area insets for iPhone notch */
        nav.sticky {
            padding-top: env(safe-area-inset-top);
        }

        .fixed.bottom-0 {
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
        }

        /* Animations for toast/notifications */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-out; }
        .animate-slide-up { animation: slide-up 0.4s ease-out; }

        /* Smooth animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes progressFill {
            from { width: 0%; }
        }

        @keyframes numberCount {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .progress-bar {
            animation: progressFill 1s ease-out;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card {
            animation: slideUp 0.5s ease-out;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 20px -4px rgba(0, 0, 0, 0.12);
        }

        .plan-card {
            transition: all 0.2s ease;
        }

        .plan-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.1);
        }

        .insight-card {
            animation: slideUp 0.4s ease-out;
        }

        /* Gradient text effects */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Enhanced progress bars */
        .progress-container {
            position: relative;
            overflow: hidden;
        }

        .progress-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% { left: 100%; }
        }

        /* Button effects */
        button {
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }
    </style>
    <script src="meals/plans.js"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-rose-50 min-h-screen antialiased">

    <!-- Header -->
    <header class="hero-gradient shadow-xl relative overflow-hidden">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <div class="inline-block mb-4">
                    <span class="text-5xl">ðŸ“Š</span>
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight mb-3">
                    Nutrition Dashboard
                </h1>
                <p class="text-xl text-white/95 max-w-2xl mx-auto mb-6 font-light">
                    Compare meal plans â€¢ Track macros â€¢ Visualize your weekly nutrition
                </p>
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold rounded-xl transition-all duration-200 border-2 border-white/40">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Wave separator -->
        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
                <path d="M0 0L60 8C120 16 240 32 360 37.3C480 43 600 37 720 34.7C840 32 960 32 1080 37.3C1200 43 1320 53 1380 58.7L1440 64V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V0Z" fill="#fef7f5" fill-opacity="0.9"/>
            </svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Plan Selector -->
        <div class="bg-white shadow-lg rounded-xl p-6 mb-8 fade-in hover:shadow-xl transition-shadow duration-300">
            <h2 class="text-2xl font-bold mb-4 border-b border-slate-100 pb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Select Plans to Compare</h2>

            <!-- Smart Suggestions -->
            <div id="smart-suggestions" class="hidden mb-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="font-bold text-purple-900 mb-1 flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Smart Suggestion
                        </h3>
                        <p class="text-sm text-purple-800" id="suggestion-text"></p>
                    </div>
                    <button onclick="applyFrequentSelections()" class="ml-4 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-sm hover:shadow-md">
                        Use My Usual
                    </button>
                </div>
            </div>

            <div id="plan-selector" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Dynamically generated -->
            </div>
        </div>

        <!-- Nutrition Summary -->
        <div id="nutrition-summary" class="hidden">
            <!-- Weekly Totals -->
            <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-l-4 border-blue-500 rounded-r-xl p-6 mb-8 shadow-lg slide-up">
                <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="text-3xl mr-2">ðŸ“ˆ</span>
                    <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Weekly Nutrition Summary</span>
                </h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-md stat-card border-2 border-blue-100 hover:border-blue-300">
                        <div class="text-sm font-semibold text-slate-600 mb-1">Daily Calories</div>
                        <div id="total-calories" class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent">-</div>
                        <div class="text-xs text-slate-500 mt-1 flex items-center">
                            <span class="w-2 h-2 bg-blue-400 rounded-full mr-1"></span>
                            Average per day
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md stat-card border-2 border-red-100 hover:border-red-300">
                        <div class="text-sm font-semibold text-slate-600 mb-1">Protein</div>
                        <div id="total-protein" class="text-4xl font-bold bg-gradient-to-r from-red-600 to-red-400 bg-clip-text text-transparent">-</div>
                        <div class="text-xs text-slate-500 mt-1 flex items-center">
                            <span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>
                            grams per day
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md stat-card border-2 border-amber-100 hover:border-amber-300">
                        <div class="text-sm font-semibold text-slate-600 mb-1">Carbs</div>
                        <div id="total-carbs" class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-amber-400 bg-clip-text text-transparent">-</div>
                        <div class="text-xs text-slate-500 mt-1 flex items-center">
                            <span class="w-2 h-2 bg-amber-400 rounded-full mr-1"></span>
                            grams per day
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md stat-card border-2 border-emerald-100 hover:border-emerald-300">
                        <div class="text-sm font-semibold text-slate-600 mb-1">Fat</div>
                        <div id="total-fat" class="text-4xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-400 bg-clip-text text-transparent">-</div>
                        <div class="text-xs text-slate-500 mt-1 flex items-center">
                            <span class="w-2 h-2 bg-emerald-400 rounded-full mr-1"></span>
                            grams per day
                        </div>
                    </div>
                </div>
            </div>

            <!-- Macro Distribution -->
            <div class="bg-white shadow-lg rounded-xl p-6 mb-8 slide-up hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-2xl font-bold mb-4 border-b border-slate-100 pb-2 bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">ðŸ¥— Macro Distribution</h2>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-bold text-red-700 flex items-center">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                Protein
                            </span>
                            <span id="protein-percent" class="font-semibold text-slate-700">-</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 progress-container overflow-hidden shadow-inner">
                            <div id="protein-bar" class="progress-bar bg-gradient-to-r from-red-500 to-red-400 h-4 rounded-full shadow-sm" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-bold text-amber-700 flex items-center">
                                <span class="w-3 h-3 bg-amber-500 rounded-full mr-2"></span>
                                Carbohydrates
                            </span>
                            <span id="carbs-percent" class="font-semibold text-slate-700">-</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 progress-container overflow-hidden shadow-inner">
                            <div id="carbs-bar" class="progress-bar bg-gradient-to-r from-amber-500 to-amber-400 h-4 rounded-full shadow-sm" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-bold text-emerald-700 flex items-center">
                                <span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span>
                                Fat
                            </span>
                            <span id="fat-percent" class="font-semibold text-slate-700">-</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 progress-container overflow-hidden shadow-inner">
                            <div id="fat-bar" class="progress-bar bg-gradient-to-r from-emerald-500 to-emerald-400 h-4 rounded-full shadow-sm" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plan Comparison Table -->
            <div class="bg-white shadow rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">ðŸ“‹ Plan Comparison</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="text-left py-3 px-4 font-semibold text-slate-700">Plan</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Calories</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Protein</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Carbs</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Fat</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Fiber</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table">
                            <!-- Dynamically generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Weekly Goals -->
            <div class="bg-white shadow rounded-xl p-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">ðŸŽ¯ Weekly Goals & Insights</h2>
                <div id="insights-content" class="space-y-4">
                    <!-- Dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 bg-white shadow rounded-xl">
            <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <p class="text-slate-500 text-lg">Select meal plans above to see nutritional analysis</p>
        </div>

    </main>

    <footer class="text-center text-slate-400 text-sm py-8 mt-12">
        <p>Nutrition Dashboard â€¢ Smart meal planning insights</p>
    </footer>

    <script>
        // Nutritional data for each plan (estimated based on meal descriptions)
        const nutritionData = {
            'week1-meals.html': {
                calories: 2000, protein: 180, carbs: 180, fat: 60, fiber: 30,
                description: 'High protein Asian meals for weight loss'
            },
            'week1-breakfast.html': {
                calories: 450, protein: 38, carbs: 35, fat: 15, fiber: 8,
                description: 'High-protein breakfast options'
            },
            'week2-meals.html': {
                calories: 1950, protein: 175, carbs: 175, fat: 58, fiber: 28,
                description: 'Varied Asian-inspired meal prep'
            },
            'week2-breakfast.html': {
                calories: 440, protein: 36, carbs: 38, fat: 14, fiber: 7,
                description: 'Quick morning protein meals'
            },
            'week3-meals.html': {
                calories: 2050, protein: 185, carbs: 185, fat: 62, fiber: 32,
                description: 'Shrimp, curry & mapo tofu meals'
            },
            'week3-breakfast.html': {
                calories: 430, protein: 37, carbs: 36, fat: 13, fiber: 9,
                description: 'Savory oats & smoothie options'
            }
        };

        // localStorage keys
        const NUTRITION_STORAGE_KEY = 'meal_plans_nutrition_selections';
        const NUTRITION_FREQUENCY_KEY = 'meal_plans_nutrition_frequency';

        // Load selections
        function loadSelections() {
            const saved = localStorage.getItem(NUTRITION_STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        // Save selections
        function saveSelections(selections) {
            localStorage.setItem(NUTRITION_STORAGE_KEY, JSON.stringify(selections));
        }

        // Track selection frequency
        function trackSelectionFrequency(selections) {
            const frequency = loadFrequency();
            selections.forEach(file => {
                frequency[file] = (frequency[file] || 0) + 1;
            });
            localStorage.setItem(NUTRITION_FREQUENCY_KEY, JSON.stringify(frequency));
        }

        // Load frequency data
        function loadFrequency() {
            const saved = localStorage.getItem(NUTRITION_FREQUENCY_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        // Get most frequent selections
        function getFrequentSelections(topN = 3) {
            const frequency = loadFrequency();
            return Object.entries(frequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([file, count]) => file);
        }

        // Apply frequent selections
        function applyFrequentSelections() {
            const frequent = getFrequentSelections();
            if (frequent.length === 0) return;

            // Check the frequent checkboxes
            frequent.forEach(file => {
                const checkbox = document.getElementById(`nutrition-${file}`);
                if (checkbox) checkbox.checked = true;
            });

            updateNutritionSummary();
        }

        // Show smart suggestions
        function showSmartSuggestions() {
            const frequent = getFrequentSelections();
            const savedSelections = loadSelections();

            // Only show if we have frequent selections and current selection is empty
            if (frequent.length > 0 && savedSelections.length === 0) {
                const suggestionDiv = document.getElementById('smart-suggestions');
                const suggestionText = document.getElementById('suggestion-text');

                const planNames = frequent.map(file => {
                    const plan = mealPlans.find(p => p.file === file);
                    return plan ? plan.title : file;
                }).join(', ');

                suggestionText.textContent = `You usually compare: ${planNames}`;
                suggestionDiv.classList.remove('hidden');
            }
        }

        // Generate plan selector
        function generatePlanSelector() {
            const container = document.getElementById('plan-selector');
            const savedSelections = loadSelections();

            mealPlans.forEach(plan => {
                const isChecked = savedSelections.includes(plan.file);
                const colorClass = `bg-${plan.color}-50 border-${plan.color}-200 hover:bg-${plan.color}-100`;

                const card = document.createElement('div');
                card.className = `${colorClass} border-2 rounded-xl p-4 transition cursor-pointer plan-card shadow-sm hover:shadow-md`;
                card.innerHTML = `
                    <div class="flex items-start">
                        <input
                            type="checkbox"
                            id="nutrition-${plan.file}"
                            value="${plan.file}"
                            ${isChecked ? 'checked' : ''}
                            onchange="updateNutritionSummary()"
                            class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-3 mt-0.5"
                        >
                        <div class="flex-1">
                            <label for="nutrition-${plan.file}" class="cursor-pointer">
                                <h3 class="font-bold text-slate-800 mb-1">${plan.title}</h3>
                                <p class="text-sm text-slate-600">${plan.subtitle}</p>
                            </label>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Show smart suggestions after selector is generated
            showSmartSuggestions();
        }

        // Calculate nutrition totals
        function calculateTotals(selectedPlans) {
            let totals = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };

            selectedPlans.forEach(file => {
                const data = nutritionData[file];
                if (data) {
                    totals.calories += data.calories;
                    totals.protein += data.protein;
                    totals.carbs += data.carbs;
                    totals.fat += data.fat;
                    totals.fiber += data.fiber;
                }
            });

            return totals;
        }

        // Update nutrition summary
        function updateNutritionSummary() {
            const checkboxes = document.querySelectorAll('#plan-selector input[type="checkbox"]:checked');
            const selectedFiles = Array.from(checkboxes).map(cb => cb.value);

            // Save selections and track frequency
            saveSelections(selectedFiles);
            if (selectedFiles.length > 0) {
                trackSelectionFrequency(selectedFiles);
            }

            const summarySection = document.getElementById('nutrition-summary');
            const emptyState = document.getElementById('empty-state');

            if (selectedFiles.length === 0) {
                summarySection.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            summarySection.classList.remove('hidden');
            emptyState.classList.add('hidden');

            // Calculate totals
            const totals = calculateTotals(selectedFiles);

            // Update summary cards
            document.getElementById('total-calories').textContent = Math.round(totals.calories);
            document.getElementById('total-protein').textContent = Math.round(totals.protein);
            document.getElementById('total-carbs').textContent = Math.round(totals.carbs);
            document.getElementById('total-fat').textContent = Math.round(totals.fat);

            // Calculate macro percentages (based on calories)
            const proteinCals = totals.protein * 4;
            const carbsCals = totals.carbs * 4;
            const fatCals = totals.fat * 9;
            const totalMacroCals = proteinCals + carbsCals + fatCals;

            const proteinPercent = (proteinCals / totalMacroCals * 100).toFixed(0);
            const carbsPercent = (carbsCals / totalMacroCals * 100).toFixed(0);
            const fatPercent = (fatCals / totalMacroCals * 100).toFixed(0);

            document.getElementById('protein-percent').textContent = `${proteinPercent}% (${Math.round(totals.protein)}g)`;
            document.getElementById('carbs-percent').textContent = `${carbsPercent}% (${Math.round(totals.carbs)}g)`;
            document.getElementById('fat-percent').textContent = `${fatPercent}% (${Math.round(totals.fat)}g)`;

            document.getElementById('protein-bar').style.width = proteinPercent + '%';
            document.getElementById('carbs-bar').style.width = carbsPercent + '%';
            document.getElementById('fat-bar').style.width = fatPercent + '%';

            // Update comparison table
            const tableBody = document.getElementById('comparison-table');
            tableBody.innerHTML = '';

            selectedFiles.forEach(file => {
                const plan = mealPlans.find(p => p.file === file);
                const data = nutritionData[file];

                if (plan && data) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-100 hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 font-medium text-slate-700">${plan.title}</td>
                        <td class="py-3 px-4 text-right text-slate-600">${data.calories}</td>
                        <td class="py-3 px-4 text-right text-slate-600">${data.protein}g</td>
                        <td class="py-3 px-4 text-right text-slate-600">${data.carbs}g</td>
                        <td class="py-3 px-4 text-right text-slate-600">${data.fat}g</td>
                        <td class="py-3 px-4 text-right text-slate-600">${data.fiber}g</td>
                    `;
                    tableBody.appendChild(row);
                }
            });

            // Update insights
            updateInsights(totals, selectedFiles);
        }

        // Generate insights
        function updateInsights(totals, selectedFiles) {
            const insightsContent = document.getElementById('insights-content');
            const insights = [];

            // Protein analysis
            const proteinPerKgBW = (totals.protein / 82).toFixed(1); // Assuming 180 lbs = 82 kg target
            if (proteinPerKgBW >= 2.0) {
                insights.push({
                    type: 'success',
                    icon: 'âœ“',
                    text: `Excellent protein intake: ${proteinPerKgBW}g/kg body weight. Perfect for muscle preservation during weight loss.`
                });
            } else if (proteinPerKgBW >= 1.6) {
                insights.push({
                    type: 'info',
                    icon: 'â„¹',
                    text: `Good protein intake: ${proteinPerKgBW}g/kg body weight. Consider adding 20-30g more for optimal muscle retention.`
                });
            }

            // Calorie deficit
            if (totals.calories < 2200) {
                const deficit = 2500 - totals.calories; // Assuming 2500 maintenance
                const weeklyLoss = (deficit * 7 / 3500).toFixed(1);
                insights.push({
                    type: 'success',
                    icon: 'ðŸ“‰',
                    text: `Calorie deficit of ${deficit} calories/day. Projected weight loss: ~${weeklyLoss} lbs/week.`
                });
            }

            // Fiber analysis
            if (totals.fiber >= 25) {
                insights.push({
                    type: 'success',
                    icon: 'ðŸŒ¾',
                    text: `Great fiber intake: ${totals.fiber}g/day. Excellent for satiety and gut health.`
                });
            } else {
                insights.push({
                    type: 'warning',
                    icon: 'âš ',
                    text: `Fiber intake: ${totals.fiber}g/day. Consider adding vegetables or whole grains to reach 25-30g.`
                });
            }

            // Meal combo analysis
            const hasMeals = selectedFiles.some(f => f.includes('meals'));
            const hasBreakfast = selectedFiles.some(f => f.includes('breakfast'));

            if (hasMeals && hasBreakfast) {
                insights.push({
                    type: 'info',
                    icon: 'ðŸ½ï¸',
                    text: `Complete meal plan selected. Remember to account for snacks and adjust portions based on your hunger levels.`
                });
            }

            // Render insights
            insightsContent.innerHTML = insights.map(insight => {
                const colors = {
                    success: 'bg-green-50 border-green-400 text-green-800',
                    info: 'bg-blue-50 border-blue-400 text-blue-800',
                    warning: 'bg-amber-50 border-amber-400 text-amber-800'
                };

                return `
                    <div class="${colors[insight.type]} border-l-4 p-4 rounded-r-lg">
                        <div class="flex items-start">
                            <span class="text-xl mr-3">${insight.icon}</span>
                            <p class="text-sm">${insight.text}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Check for preselected plan from meal plan page
        function checkPreselection() {
            const preselectPlan = localStorage.getItem('preselect_plan');
            if (preselectPlan) {
                // Clear the preselect flag
                localStorage.removeItem('preselect_plan');

                // Check if this plan isn't already selected
                const savedSelections = loadSelections();
                if (!savedSelections.includes(preselectPlan)) {
                    // Add it to selections
                    savedSelections.push(preselectPlan);
                    saveSelections(savedSelections);

                    // Check the checkbox
                    const checkbox = document.getElementById(`nutrition-${preselectPlan}`);
                    if (checkbox) checkbox.checked = true;
                }

                // Scroll to the summary after a brief delay
                setTimeout(() => {
                    document.getElementById('nutrition-summary')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generatePlanSelector();
            checkPreselection();
            updateNutritionSummary();
        });
    </script>

<!-- Dark Mode Toggle Button - Include in all pages -->
<button
    id="dark-mode-toggle"
    onclick="toggleDarkMode()"
    class="fixed top-4 right-4 z-[100] w-12 h-12 rounded-full bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group border-2 border-transparent hover:border-orange-400 no-print"
    aria-label="Toggle dark mode"
    title="Toggle dark mode"
>
    <!-- Sun Icon (visible in dark mode) -->
    <svg
        class="w-6 h-6 text-yellow-500 dark-mode-icon-sun hidden"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
    >
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
        />
    </svg>

    <!-- Moon Icon (visible in light mode) -->
    <svg
        class="w-6 h-6 text-slate-700 dark-mode-icon-moon"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
    >
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
        />
    </svg>
</button>

<style>
    /* Dark mode toggle icon visibility */
    [data-theme="dark"] .dark-mode-icon-moon {
        display: none;
    }

    [data-theme="dark"] .dark-mode-icon-sun {
        display: block;
    }

    [data-theme="light"] .dark-mode-icon-sun {
        display: none;
    }

    [data-theme="light"] .dark-mode-icon-moon {
        display: block;
    }

    /* Pulse animation on first load */
    @keyframes pulse-once {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    #dark-mode-toggle.first-load {
        animation: pulse-once 0.5s ease-out;
    }

    /* Rotate animation on click */
    @keyframes rotate-icon {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #dark-mode-toggle.rotating svg {
        animation: rotate-icon 0.5s ease-out;
    }

    /* Position adjustment for mobile bottom nav */
    @media (max-width: 767px) {
        #dark-mode-toggle {
            top: auto;
            bottom: 5rem;
            right: 1rem;
        }
    }

    /* Print mode - hide toggle */
    @media print {
        #dark-mode-toggle {
            display: none !important;
        }
    }
</style>

<script>
    // Add rotating animation on click
    document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                toggle.classList.add('rotating');
                setTimeout(() => {
                    toggle.classList.remove('rotating');
                }, 500);
            });

            // Pulse animation on first load to draw attention
            if (!localStorage.getItem('dark-mode-toggle-seen')) {
                setTimeout(() => {
                    toggle.classList.add('first-load');
                    setTimeout(() => {
                        toggle.classList.remove('first-load');
                        localStorage.setItem('dark-mode-toggle-seen', 'true');
                    }, 500);
                }, 1000);
            }
        }
    });
</script>

</body>
</html>
