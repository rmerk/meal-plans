<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#F06C6C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Settings - Meal Plans</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./dist/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="mobile-utils.js"></script>
    <script src="notifications.js"></script>
    <link rel="stylesheet" href="./dark-mode.css">
    <link rel="stylesheet" href="./landscape.css">
    <style>
        body { font-family: 'DM Sans', sans-serif; }
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em; }

        /* Atomic Age Sunset Color Palette */
        :root {
            --coral: #F06C6C;
            --coral-dark: #D95555;
            --sage: #87AB8F;
            --sage-light: #A4C4A7;
            --butter: #F4D35E;
            --butter-light: #FFE66D;
            --taupe: #C9B5A0;
            --warm-brown: #8B6F47;
            --warm-cream: #FFF8F0;
            --soft-peach: #FFE5D9;
            --charcoal: #2D3748;
        }

        .bg-coral { background-color: var(--coral); }
        .bg-sage { background-color: var(--sage); }
        .bg-butter { background-color: var(--butter); }
        .text-coral { color: var(--coral); }
        .text-sage { color: var(--sage); }
        .text-butter { color: var(--butter); }
        .border-coral { border-color: var(--coral); }

        .hero-gradient {
            background: linear-gradient(135deg, var(--coral) 0%, var(--butter) 50%, var(--sage-light) 100%);
        }

        .setting-card {
            transition: all 0.2s ease;
        }

        .setting-card:hover {
            transform: translateX(4px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--coral);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Form focus styles */
        select:focus, input:focus {
            outline-color: var(--coral);
            border-color: var(--coral);
            outline-width: 2px;
            outline-style: solid;
        }
    </style>
</head>
<body class="min-h-screen antialiased" style="background: linear-gradient(135deg, var(--warm-cream) 0%, var(--soft-peach) 50%, var(--sage-light) 100%);">

    <!-- Header -->
    <header class="hero-gradient shadow-xl relative overflow-hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <div class="inline-block mb-4">
                    <span class="text-5xl">‚öôÔ∏è</span>
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight mb-3">
                    Settings
                </h1>
                <p class="text-xl text-white/95 max-w-2xl mx-auto mb-6 font-light">
                    Customize your experience ‚Ä¢ Configure notifications ‚Ä¢ Manage data
                </p>
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold rounded-xl transition-all duration-200 border-2 border-white/40">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
                <path d="M0 0L60 8C120 16 240 32 360 37.3C480 43 600 37 720 34.7C840 32 960 32 1080 37.3C1200 43 1320 53 1380 58.7L1440 64V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V0Z" fill="#fef7f5" fill-opacity="0.9"/>
            </svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Appearance Settings -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-2 border-orange-200 fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center pb-4 border-b-2 border-orange-100">
                <span class="text-2xl mr-3">üé®</span>
                Appearance
            </h2>

            <div class="space-y-4">
                <!-- Theme Selection -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Theme</div>
                        <div class="text-sm text-slate-600">Choose your color theme</div>
                    </div>
                    <select id="theme-select" onchange="changeTheme(this.value)" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                        <option value="auto">Auto</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>

                <!-- Haptic Feedback -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Haptic Feedback</div>
                        <div class="text-sm text-slate-600">Vibration on button taps</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="haptic-toggle" onchange="toggleHaptic(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-2 border-orange-200 fade-in" style="animation-delay: 0.1s">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center pb-4 border-b-2 border-orange-100">
                <span class="text-2xl mr-3">üîî</span>
                Notifications
            </h2>

            <div class="space-y-4">
                <!-- Enable Notifications -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Enable Notifications</div>
                        <div class="text-sm text-slate-600">Receive meal prep reminders</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notifications-enabled" onchange="updateNotificationSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Meal Prep Reminders -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Meal Prep Reminders</div>
                        <div class="text-sm text-slate-600">Weekly prep day notifications</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="meal-prep-reminders" onchange="updateNotificationSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Weekly Prep Day -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Weekly Prep Day</div>
                        <div class="text-sm text-slate-600">Day to receive prep reminders</div>
                    </div>
                    <select id="prep-day" onchange="updateNotificationSettings()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>

                <!-- Prep Time -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Prep Time</div>
                        <div class="text-sm text-slate-600">Time to receive reminders</div>
                    </div>
                    <input type="time" id="prep-time" onchange="updateNotificationSettings()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                </div>

                <!-- Cooking Timers -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Cooking Timer Alerts</div>
                        <div class="text-sm text-slate-600">Notify when timers complete</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="cooking-timers" onchange="updateNotificationSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Quiet Hours -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Quiet Hours</div>
                        <div class="text-sm text-slate-600">Silence notifications during set hours</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="quiet-hours-enabled" onchange="updateNotificationSettings(); toggleQuietHoursInputs()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Quiet Hours Time Range -->
                <div id="quiet-hours-inputs" class="hidden space-y-4 pl-4 border-l-2 border-slate-300">
                    <div class="setting-card flex items-center justify-between p-4 bg-white rounded-lg">
                        <div>
                            <div class="font-semibold text-slate-700">Start Time</div>
                        </div>
                        <input type="time" id="quiet-start" onchange="updateNotificationSettings()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                    </div>
                    <div class="setting-card flex items-center justify-between p-4 bg-white rounded-lg">
                        <div>
                            <div class="font-semibold text-slate-700">End Time</div>
                        </div>
                        <input type="time" id="quiet-end" onchange="updateNotificationSettings()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                    </div>
                </div>

                <!-- Test Notification -->
                <div class="mt-4 pt-4 border-t border-slate-200">
                    <button onclick="testNotification()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        Test Notification
                    </button>
                </div>
            </div>
        </div>

        <!-- Preferences -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-2 border-orange-200 fade-in" style="animation-delay: 0.2s">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center pb-4 border-b-2 border-orange-100">
                <span class="text-2xl mr-3">üéØ</span>
                Preferences
            </h2>

            <div class="space-y-4">
                <!-- Default Servings -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Default Servings</div>
                        <div class="text-sm text-slate-600">Standard serving size for recipes</div>
                    </div>
                    <input type="number" id="default-servings" min="1" max="20" value="4" step="1" onchange="savePreference('defaultServings', this.value)" class="w-20 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent text-center">
                </div>

                <!-- Units -->
                <div class="setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-semibold text-slate-800">Measurement Units</div>
                        <div class="text-sm text-slate-600">Preferred unit system</div>
                    </div>
                    <select id="units-preference" onchange="savePreference('units', this.value)" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-coral focus:border-transparent">
                        <option value="imperial">Imperial (cups, oz, lbs)</option>
                        <option value="metric">Metric (ml, g, kg)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-orange-200 fade-in" style="animation-delay: 0.3s">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center pb-4 border-b-2 border-orange-100">
                <span class="text-2xl mr-3">üíæ</span>
                Data Management
            </h2>

            <div class="space-y-4">
                <!-- Export Data -->
                <button onclick="exportAllData()" class="w-full setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <div class="text-left">
                        <div class="font-semibold text-slate-800">Export Data</div>
                        <div class="text-sm text-slate-600">Download all your data as JSON</div>
                    </div>
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                </button>

                <!-- Import Data -->
                <button onclick="document.getElementById('import-file').click()" class="w-full setting-card flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <div class="text-left">
                        <div class="font-semibold text-slate-800">Import Data</div>
                        <div class="text-sm text-slate-600">Restore from backup file</div>
                    </div>
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                </button>
                <input type="file" id="import-file" accept=".json" onchange="importData(this)" class="hidden">

                <!-- Clear Cache -->
                <button onclick="clearCache()" class="w-full setting-card flex items-center justify-between p-4 bg-red-50 rounded-lg hover:bg-red-100 transition border border-red-200">
                    <div class="text-left">
                        <div class="font-semibold text-red-800">Clear Cache</div>
                        <div class="text-sm text-red-600">Remove all stored data</div>
                    </div>
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- About -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6 border-2 border-orange-200 text-center fade-in" style="animation-delay: 0.4s">
            <h3 class="font-bold text-slate-800 mb-2">Meal Planning App</h3>
            <p class="text-sm text-slate-600 mb-2">Version 2.0.0</p>
            <p class="text-xs text-slate-500">Built with ‚ù§Ô∏è for healthy eating</p>
        </div>

    </main>

    <footer class="text-center text-slate-400 text-sm py-8 mt-12">
        <p>Settings ‚Ä¢ Your data is stored locally on your device</p>
    </footer>

    <script>
        const PREFERENCES_KEY = 'meal_plan_preferences';

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSettings();
        });

        // Load all settings
        function loadAllSettings() {
            // Check if notification system is available
            if (!window.notificationManager) {
                // Notification system unavailable - show warning and disable controls
                showNotificationUnavailableWarning();
                disableNotificationControls();
            } else {
                // Load notification settings
                const settings = notificationManager.settings;
                document.getElementById('notifications-enabled').checked = settings.enabled;
                document.getElementById('meal-prep-reminders').checked = settings.mealPrepReminders;
                document.getElementById('cooking-timers').checked = settings.cookingTimers;
                document.getElementById('prep-day').value = settings.weeklyPrepDay;
                document.getElementById('prep-time').value = settings.weeklyPrepTime;
                document.getElementById('quiet-hours-enabled').checked = settings.quietHoursEnabled;
                document.getElementById('quiet-start').value = settings.quietHoursStart;
                document.getElementById('quiet-end').value = settings.quietHoursEnd;

                toggleQuietHoursInputs();
            }

            // Load theme (use unified 'theme' key from mobile-utils.js)
            const theme = localStorage.getItem('theme') || 'auto';
            document.getElementById('theme-select').value = theme;

            // Load haptic feedback preference (use 'haptics-disabled' key from mobile-utils.js)
            const hapticsDisabled = localStorage.getItem('haptics-disabled') === 'true';
            document.getElementById('haptic-toggle').checked = !hapticsDisabled;

            // Load preferences
            loadPreferences();
        }

        // Show warning when notification system is unavailable
        function showNotificationUnavailableWarning() {
            const notificationSection = document.querySelector('.bg-white.rounded-2xl.shadow-lg:nth-of-type(2)');
            if (notificationSection) {
                const warningBanner = document.createElement('div');
                warningBanner.className = 'bg-amber-50 border-l-4 border-amber-500 p-4 mb-4 rounded-lg';
                warningBanner.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-amber-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-amber-800">Notification System Unavailable</h4>
                            <p class="text-sm text-amber-700 mt-1">The notification system failed to load. Notification settings are currently disabled. Please refresh the page or check your browser console for errors.</p>
                        </div>
                    </div>
                `;
                notificationSection.insertBefore(warningBanner, notificationSection.children[1]);
            }
        }

        // Disable notification controls when system unavailable
        function disableNotificationControls() {
            const notificationInputs = [
                'notifications-enabled',
                'meal-prep-reminders',
                'cooking-timers',
                'prep-day',
                'prep-time',
                'quiet-hours-enabled',
                'quiet-start',
                'quiet-end'
            ];

            notificationInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = true;
                    element.style.opacity = '0.5';
                    element.style.cursor = 'not-allowed';
                }
            });

            // Disable test notification button
            const testButton = document.querySelector('button[onclick="testNotification()"]');
            if (testButton) {
                testButton.disabled = true;
                testButton.style.opacity = '0.5';
                testButton.style.cursor = 'not-allowed';
                testButton.onclick = function(e) {
                    e.preventDefault();
                    if (window.showToast) {
                        showToast('‚ö†Ô∏è Notification system unavailable');
                    } else {
                        alert('Notification system unavailable');
                    }
                    return false;
                };
            }
        }

        // Update notification settings
        function updateNotificationSettings() {
            if (!window.notificationManager) return;

            notificationManager.saveSettings({
                enabled: document.getElementById('notifications-enabled').checked,
                mealPrepReminders: document.getElementById('meal-prep-reminders').checked,
                cookingTimers: document.getElementById('cooking-timers').checked,
                weeklyPrepDay: parseInt(document.getElementById('prep-day').value),
                weeklyPrepTime: document.getElementById('prep-time').value,
                quietHoursEnabled: document.getElementById('quiet-hours-enabled').checked,
                quietHoursStart: document.getElementById('quiet-start').value,
                quietHoursEnd: document.getElementById('quiet-end').value
            });

            // Provide visual feedback
            if (window.showToast) {
                showToast('‚úÖ Notification settings saved');
            }
        }

        // Toggle quiet hours inputs
        function toggleQuietHoursInputs() {
            const enabled = document.getElementById('quiet-hours-enabled').checked;
            const inputs = document.getElementById('quiet-hours-inputs');
            if (enabled) {
                inputs.classList.remove('hidden');
            } else {
                inputs.classList.add('hidden');
            }
        }

        // Change theme (unified with mobile-utils.js)
        function changeTheme(themeValue) {
            let appliedTheme;

            if (themeValue === 'auto') {
                // Auto mode: remove manual preference and follow system
                localStorage.removeItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                appliedTheme = prefersDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', appliedTheme);
            } else if (themeValue === 'dark' || themeValue === 'light') {
                // Manual theme selection
                localStorage.setItem('theme', themeValue);
                appliedTheme = themeValue;
                document.documentElement.setAttribute('data-theme', themeValue);
            }

            // Dispatch event for custom reactions (for all theme changes)
            if (appliedTheme) {
                window.dispatchEvent(new CustomEvent('themechange', {
                    detail: { theme: appliedTheme }
                }));
            }

            // Provide haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }

        // Toggle haptic feedback (unified with mobile-utils.js)
        function toggleHaptic(enabled) {
            // Use inverse logic: store 'haptics-disabled' instead of 'haptic-enabled'
            localStorage.setItem('haptics-disabled', !enabled);

            // Test vibration if being enabled
            if (enabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // Load preferences
        function loadPreferences() {
            const saved = localStorage.getItem(PREFERENCES_KEY);
            if (saved) {
                const prefs = JSON.parse(saved);
                if (prefs.defaultServings) document.getElementById('default-servings').value = prefs.defaultServings;
                if (prefs.units) document.getElementById('units-preference').value = prefs.units;
            }
        }

        // Save preference
        function savePreference(key, value) {
            // Validate default servings
            if (key === 'defaultServings') {
                const numValue = parseInt(value);
                if (isNaN(numValue) || numValue < 1 || numValue > 20) {
                    if (window.showToast) {
                        showToast('‚ùå Servings must be between 1 and 20');
                    } else {
                        alert('Servings must be between 1 and 20');
                    }
                    // Reset to default
                    document.getElementById('default-servings').value = 4;
                    return;
                }
                value = numValue; // Ensure it's stored as a number
            }

            const saved = localStorage.getItem(PREFERENCES_KEY);
            const prefs = saved ? JSON.parse(saved) : {};
            prefs[key] = value;
            localStorage.setItem(PREFERENCES_KEY, JSON.stringify(prefs));

            // Provide visual feedback
            if (window.showToast) {
                showToast('‚úÖ Preference saved');
            }
        }

        // Export all data
        function exportAllData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meal-plans-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (window.showToast) {
                showToast('‚úÖ Data exported successfully!');
            } else {
                alert('Data exported successfully!');
            }
        }

        // Import data
        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.entries(data).forEach(([key, value]) => {
                        localStorage.setItem(key, value);
                    });

                    if (window.showToast) {
                        showToast('‚úÖ Data imported successfully! Page will refresh...');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        alert('Data imported successfully! Page will refresh.');
                        location.reload();
                    }
                } catch (error) {
                    if (window.showToast) {
                        showToast('‚ùå Error importing data. Please check the file format.');
                    } else {
                        alert('Error importing data. Please check the file format.');
                    }
                }
            };
            reader.readAsText(file);
        }

        // Clear cache
        function clearCache() {
            if (!confirm('This will delete all your data including meal plans, shopping lists, and settings. Are you sure?')) {
                return;
            }

            if (!confirm('This cannot be undone. Really clear all data?')) {
                return;
            }

            localStorage.clear();

            if (window.showToast) {
                showToast('üóëÔ∏è All data cleared. Page will refresh...');
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('All data cleared. Page will refresh.');
                location.reload();
            }
        }
    </script>

</body>
</html>
