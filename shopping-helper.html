<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shopping Helper - Meal Plans</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Custom terracotta/orange color palette */
        :root {
            --terracotta: #d4735e;
            --terracotta-dark: #b85c47;
            --warm-orange: #e88d67;
        }

        .bg-terracotta { background-color: var(--terracotta); }
        .text-terracotta { color: var(--terracotta); }
        .border-terracotta { border-color: var(--terracotta); }

        .hero-gradient {
            background: linear-gradient(135deg, #d4735e 0%, #e88d67 50%, #ffa07a 100%);
        }

        /* Smooth animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Hover effects */
        .plan-checkbox:hover {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }

        .ingredient-item {
            transition: all 0.2s ease;
        }

        .ingredient-item:hover {
            background: linear-gradient(to right, rgba(241, 245, 249, 0.5), rgba(248, 250, 252, 0.5));
        }

        /* Button animations */
        button {
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        button:active {
            transform: translateY(0);
        }

        /* Enhanced shadows */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: box-shadow 0.3s ease;
        }

        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .consolidated-list ul { column-count: 2; column-gap: 20px; }
        }
    </style>
    <script src="meals/plans.js"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-rose-50 min-h-screen antialiased">

    <!-- Header -->
    <header class="hero-gradient shadow-xl relative overflow-hidden">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <div class="inline-block mb-4">
                    <span class="text-5xl">üõí</span>
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight mb-3">
                    Smart Shopping Helper
                </h1>
                <p class="text-xl text-white/95 max-w-2xl mx-auto mb-6 font-light">
                    Auto-merge ingredients across weeks ‚Ä¢ Export to CSV ‚Ä¢ Never lose your selections
                </p>
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold rounded-xl transition-all duration-200 border-2 border-white/40 no-print">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Wave separator -->
        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
                <path d="M0 0L60 8C120 16 240 32 360 37.3C480 43 600 37 720 34.7C840 32 960 32 1080 37.3C1200 43 1320 53 1380 58.7L1440 64V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V0Z" fill="#fef7f5" fill-opacity="0.9"/>
            </svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Instructions -->
        <div class="bg-gradient-to-r from-orange-50 to-rose-50 border-l-4 border-terracotta p-6 mb-10 rounded-2xl shadow-md no-print">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-terracotta flex items-center justify-center text-2xl shadow-lg">
                        ‚ú®
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">How It Works</h3>
                    <p class="text-slate-600 leading-relaxed">
                        Automatically combines ingredient quantities ‚Ä¢ Remembers your selections ‚Ä¢ Export to CSV, Markdown, or plain text ‚Ä¢ Mark items you already have ‚Ä¢ Print-optimized layout
                    </p>
                </div>
            </div>
        </div>

        <!-- Plan Selection -->
        <div class="bg-white shadow-xl rounded-2xl p-8 mb-10 border-2 border-orange-100 fade-in">
            <div class="flex justify-between items-center mb-6 border-b-2 border-orange-50 pb-4">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-slate-800 flex items-center">
                    <span class="text-3xl mr-3">üìã</span>
                    Select Your Meal Plans
                </h2>
                <button onclick="clearSelections()" class="no-print text-sm text-slate-500 hover:text-red-600 font-semibold transition hover:scale-105 flex items-center gap-1">
                    <span class="text-lg">üóëÔ∏è</span>
                    Clear All
                </button>
            </div>

            <!-- Smart Suggestions -->
            <div id="smart-suggestions" class="hidden mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl no-print">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="font-bold text-blue-900 mb-1 flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Smart Suggestion
                        </h3>
                        <p class="text-sm text-blue-800" id="suggestion-text"></p>
                    </div>
                    <button onclick="applyFrequentSelections()" class="ml-4 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-sm hover:shadow-md">
                        Use My Usual
                    </button>
                </div>
            </div>

            <div id="plan-checkboxes" class="space-y-3">
                <!-- Dynamically generated checkboxes -->
            </div>
        </div>

        <!-- Consolidated Shopping List -->
        <div id="consolidated-section" class="bg-white shadow-xl rounded-2xl p-8 mb-10 border-2 border-orange-100 hidden">
            <div class="flex justify-between items-center mb-6 border-b-2 border-orange-50 pb-4 flex-wrap gap-4">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-slate-800 flex items-center">
                    <span class="text-3xl mr-3">üéØ</span>
                    Your Shopping List
                </h2>
                <div class="flex gap-2 no-print flex-wrap">
                    <button onclick="exportCSV()" class="bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white text-sm font-bold px-4 py-2 rounded-xl transition shadow-md hover:shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV
                    </button>
                    <button onclick="exportMarkdown()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white text-sm font-bold px-4 py-2 rounded-xl transition shadow-md hover:shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Markdown
                    </button>
                    <button onclick="window.print()" class="bg-gradient-to-r from-orange-500 to-rose-500 hover:from-orange-600 hover:to-rose-600 text-white text-sm font-bold px-4 py-2 rounded-xl transition shadow-md hover:shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        Print
                    </button>
                </div>
            </div>

            <div class="mb-4 text-sm text-slate-600 no-print">
                <span class="font-semibold">Selected:</span> <span id="selected-count">0</span> plan(s) ‚Ä¢
                <span class="font-semibold">Total Items:</span> <span id="total-items">0</span>
            </div>

            <div id="consolidated-list" class="consolidated-list grid md:grid-cols-3 gap-6">
                <!-- Dynamically generated -->
            </div>

            <!-- Meal Fatigue Warning -->
            <div id="fatigue-warning" class="hidden mt-6 p-4 bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500 rounded-r-lg no-print">
                <div class="flex items-start">
                    <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                    <div class="flex-1">
                        <h3 class="font-bold text-orange-900 mb-1">Meal Fatigue Alert</h3>
                        <p class="text-sm text-orange-800" id="fatigue-message"></p>
                    </div>
                </div>
            </div>

            <div class="mt-6 p-4 bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-lg no-print">
                <h3 class="font-semibold text-amber-900 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Pro Tips
                </h3>
                <ul class="text-sm text-amber-800 space-y-1 ml-7">
                    <li>‚úì Click items to mark as "already have" - they'll be grayed out</li>
                    <li>‚úì Quantities are automatically combined (e.g., "2 lbs + 3 lbs = 5 lbs")</li>
                    <li>‚úì Your selections are saved automatically and persist across visits</li>
                    <li>‚úì Export to CSV to import into your favorite shopping app</li>
                </ul>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 bg-white shadow rounded-xl">
            <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <p class="text-slate-500 text-lg">Select meal plans above to see your consolidated shopping list</p>
        </div>

    </main>

    <footer class="text-center text-slate-400 text-sm py-8 mt-12 no-print">
        <p>Smart Shopping Helper ‚Ä¢ Auto-saves your progress</p>
    </footer>

    <script>
        // localStorage keys
        const STORAGE_KEY = 'meal_plans_selections';
        const ALREADY_HAVE_KEY = 'meal_plans_already_have';
        const FREQUENCY_KEY = 'meal_plans_selection_frequency';

        // Load saved selections from localStorage
        function loadSelections() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        // Save selections to localStorage
        function saveSelections(selections) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(selections));
        }

        // Load "already have" items
        function loadAlreadyHave() {
            const saved = localStorage.getItem(ALREADY_HAVE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        // Save "already have" items
        function saveAlreadyHave(items) {
            localStorage.setItem(ALREADY_HAVE_KEY, JSON.stringify(items));
        }

        // Track selection frequency
        function trackSelectionFrequency(selections) {
            const frequency = loadFrequency();
            selections.forEach(file => {
                frequency[file] = (frequency[file] || 0) + 1;
            });
            localStorage.setItem(FREQUENCY_KEY, JSON.stringify(frequency));
        }

        // Load frequency data
        function loadFrequency() {
            const saved = localStorage.getItem(FREQUENCY_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        // Get most frequent selections
        function getFrequentSelections(topN = 3) {
            const frequency = loadFrequency();
            return Object.entries(frequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([file, count]) => file);
        }

        // Apply frequent selections
        function applyFrequentSelections() {
            const frequent = getFrequentSelections();
            if (frequent.length === 0) return;

            // Check the frequent checkboxes
            frequent.forEach(file => {
                const checkbox = document.getElementById(`plan-${file}`);
                if (checkbox) checkbox.checked = true;
            });

            updateConsolidatedList();
        }

        // Analyze protein variety and detect meal fatigue
        function analyzeMealFatigue(selectedFiles) {
            const fatigueWarning = document.getElementById('fatigue-warning');
            const fatigueMessage = document.getElementById('fatigue-message');

            // Only analyze meal plans (not breakfasts)
            const mealPlansSelected = selectedFiles.filter(file => file.includes('meals.html'));

            if (mealPlansSelected.length < 2) {
                fatigueWarning.classList.add('hidden');
                return;
            }

            // Count protein occurrences across selected plans
            const proteinCounts = {};
            const plansByProtein = {};

            mealPlansSelected.forEach(file => {
                const plan = mealPlans.find(p => p.file === file);
                if (plan && plan.proteins) {
                    plan.proteins.forEach(protein => {
                        proteinCounts[protein] = (proteinCounts[protein] || 0) + 1;
                        if (!plansByProtein[protein]) plansByProtein[protein] = [];
                        plansByProtein[protein].push(plan.title);
                    });
                }
            });

            // Find proteins that appear in multiple plans
            const repetitiveProteins = Object.entries(proteinCounts)
                .filter(([protein, count]) => count >= 2)
                .sort((a, b) => b[1] - a[1]);

            if (repetitiveProteins.length > 0) {
                const [topProtein, count] = repetitiveProteins[0];
                const plans = plansByProtein[topProtein].join(' and ');

                let message = `You've selected multiple weeks with ${topProtein} (in ${plans}). `;

                // Suggest alternatives
                const alternatives = [];
                if (topProtein === 'chicken') alternatives.push('Week 3 (shrimp & tofu)');
                if (topProtein === 'beef') alternatives.push('Week 2 or 3 (pork & tofu)');
                if (topProtein === 'pork') alternatives.push('Week 1 (chicken & beef)');

                if (alternatives.length > 0) {
                    message += `Consider mixing with ${alternatives.join(' or ')} for more variety!`;
                } else {
                    message += `Consider mixing different weeks for more protein variety!`;
                }

                fatigueMessage.textContent = message;
                fatigueWarning.classList.remove('hidden');
            } else {
                fatigueWarning.classList.add('hidden');
            }
        }

        // Clear all selections
        function clearSelections() {
            if (confirm('Clear all selections and start fresh?')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(ALREADY_HAVE_KEY);
                location.reload();
            }
        }

        // Show smart suggestions
        function showSmartSuggestions() {
            const frequent = getFrequentSelections();
            const savedSelections = loadSelections();

            // Only show if we have frequent selections and current selection is empty
            if (frequent.length > 0 && savedSelections.length === 0) {
                const suggestionDiv = document.getElementById('smart-suggestions');
                const suggestionText = document.getElementById('suggestion-text');

                const planNames = frequent.map(file => {
                    const plan = mealPlans.find(p => p.file === file);
                    return plan ? plan.title : file;
                }).join(', ');

                suggestionText.textContent = `You usually select: ${planNames}`;
                suggestionDiv.classList.remove('hidden');
            }
        }

        // Generate checkboxes for each meal plan
        function generatePlanCheckboxes() {
            const container = document.getElementById('plan-checkboxes');
            container.innerHTML = '';
            const savedSelections = loadSelections();

            mealPlans.forEach(plan => {
                const isChecked = savedSelections.includes(plan.file);
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center p-3 bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg hover:from-slate-100 hover:to-slate-50 transition plan-checkbox border border-slate-200';
                checkbox.innerHTML = `
                    <input
                        type="checkbox"
                        id="plan-${plan.file}"
                        value="${plan.file}"
                        ${isChecked ? 'checked' : ''}
                        onchange="updateConsolidatedList()"
                        class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-3"
                    >
                    <label for="plan-${plan.file}" class="flex-1 cursor-pointer">
                        <span class="font-semibold text-slate-800">${plan.title}</span>
                        <span class="text-sm text-slate-500 ml-2">(${plan.subtitle})</span>
                    </label>
                `;
                container.appendChild(checkbox);
            });

            // Show smart suggestions after checkboxes are generated
            showSmartSuggestions();
        }

        // Parse ingredient text to extract quantity and unit
        function parseIngredient(text) {
            // Examples: "Garlic (3-4 heads)", "Lean Ground Beef (1.25 lbs)", "Broccoli (5 heads/2lbs)"
            const match = text.match(/^(.+?)\s*\((.+?)\)$/);
            if (match) {
                return {
                    name: match[1].trim(),
                    quantity: match[2].trim(),
                    original: text
                };
            }
            return {
                name: text.trim(),
                quantity: '',
                original: text
            };
        }

        // Combine quantities (simple text concatenation for complex units)
        function combineQuantities(quantities) {
            if (quantities.length === 0) return '';
            if (quantities.length === 1) return quantities[0];

            // For numeric quantities, try to sum
            const numeric = quantities.map(q => {
                const match = q.match(/^([\d.]+)\s*(.*)$/);
                if (match) return { num: parseFloat(match[1]), unit: match[2] };
                return null;
            }).filter(x => x !== null);

            if (numeric.length > 0 && numeric.length === quantities.length && numeric.every(n => n.unit === numeric[0].unit)) {
                const sum = numeric.reduce((acc, n) => acc + n.num, 0);
                return `${sum} ${numeric[0].unit}`;
            }

            // Otherwise, just list them
            return quantities.join(' + ');
        }

        // Fetch shopping list from a meal plan HTML file
        async function fetchShoppingList(filename) {
            try {
                const response = await fetch(`meals/${filename}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const items = [];
                const shoppingSection = doc.getElementById('shopping-list');
                if (shoppingSection) {
                    const listItems = shoppingSection.querySelectorAll('li');
                    listItems.forEach(li => {
                        const checkbox = li.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            // Get category from the header color
                            const categoryHeader = li.closest('ul').previousElementSibling;
                            let category = 'Other';
                            if (categoryHeader && categoryHeader.tagName === 'H4') {
                                const text = categoryHeader.textContent.toLowerCase();
                                if (text.includes('produce')) category = 'Produce';
                                else if (text.includes('protein')) category = 'Protein';
                                else if (text.includes('pantry')) category = 'Pantry';
                            }

                            items.push({
                                text: li.textContent.trim(),
                                category: category
                            });
                        }
                    });
                }
                return items;
            } catch (error) {
                console.error(`Error fetching ${filename}:`, error);
                return [];
            }
        }

        // Update consolidated shopping list
        async function updateConsolidatedList() {
            const checkboxes = document.querySelectorAll('#plan-checkboxes input[type="checkbox"]:checked');
            const consolidatedSection = document.getElementById('consolidated-section');
            const emptyState = document.getElementById('empty-state');
            const consolidatedList = document.getElementById('consolidated-list');

            // Save selections and track frequency
            const selectedFiles = Array.from(checkboxes).map(cb => cb.value);
            saveSelections(selectedFiles);
            if (selectedFiles.length > 0) {
                trackSelectionFrequency(selectedFiles);
            }

            if (checkboxes.length === 0) {
                consolidatedSection.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            consolidatedSection.classList.remove('hidden');
            emptyState.classList.add('hidden');

            // Show loading state
            consolidatedList.innerHTML = '<div class="col-span-3 text-center py-8 text-slate-500">Loading shopping lists...</div>';

            // Fetch all shopping lists
            const allItems = [];
            for (const checkbox of checkboxes) {
                const items = await fetchShoppingList(checkbox.value);
                allItems.push(...items);
            }

            // Consolidate by ingredient name
            const consolidated = {};
            allItems.forEach(item => {
                const parsed = parseIngredient(item.text);
                const key = parsed.name.toLowerCase();

                if (!consolidated[key]) {
                    consolidated[key] = {
                        name: parsed.name,
                        quantities: [],
                        category: item.category
                    };
                }
                if (parsed.quantity) {
                    consolidated[key].quantities.push(parsed.quantity);
                }
            });

            // Group by category
            const byCategory = { Produce: [], Protein: [], Pantry: [] };
            Object.values(consolidated).forEach(item => {
                const combined = combineQuantities(item.quantities);
                byCategory[item.category].push({
                    name: item.name,
                    quantity: combined,
                    key: item.name.toLowerCase()
                });
            });

            // Sort each category
            Object.keys(byCategory).forEach(cat => {
                byCategory[cat].sort((a, b) => a.name.localeCompare(b.name));
            });

            // Load "already have" items
            const alreadyHave = loadAlreadyHave();

            // Render
            const categoryColors = {
                Produce: { bg: 'emerald', text: 'emerald-700' },
                Protein: { bg: 'red', text: 'red-700' },
                Pantry: { bg: 'amber', text: 'amber-700' }
            };

            consolidatedList.innerHTML = '';
            let totalItems = 0;

            ['Produce', 'Protein', 'Pantry'].forEach(category => {
                const items = byCategory[category];
                if (items.length === 0) return;
                totalItems += items.length;

                const color = categoryColors[category];
                const div = document.createElement('div');
                div.innerHTML = `
                    <h4 class="font-bold text-${color.text} uppercase text-sm tracking-wider mb-3 flex items-center">
                        <span class="w-3 h-3 bg-${color.bg}-400 rounded-full mr-2"></span>
                        ${category}
                    </h4>
                    <ul class="space-y-1 text-sm text-slate-700">
                        ${items.map(item => {
                            const isAlreadyHave = alreadyHave.includes(item.key);
                            const displayText = item.quantity ? `${item.name} (${item.quantity})` : item.name;
                            return `
                                <li class="flex items-start cursor-pointer ingredient-item p-2 rounded-lg transition ${isAlreadyHave ? 'line-through text-slate-400 bg-slate-50' : 'hover:bg-slate-50'}"
                                    onclick="toggleAlreadyHave('${item.key.replace(/'/g, "\\'")}')">
                                    <span class="w-2 h-2 bg-${color.bg}-400 rounded-full mr-3 mt-1.5 ${isAlreadyHave ? 'opacity-30' : ''}"></span>
                                    <span class="flex-1">${displayText}</span>
                                    ${isAlreadyHave ? '<span class="text-xs text-slate-400">‚úì</span>' : ''}
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                consolidatedList.appendChild(div);
            });

            // Update counts
            document.getElementById('selected-count').textContent = checkboxes.length;
            document.getElementById('total-items').textContent = totalItems;

            // Analyze meal fatigue
            analyzeMealFatigue(selectedFiles);
        }

        // Toggle "already have" status
        function toggleAlreadyHave(key) {
            const alreadyHave = loadAlreadyHave();
            const index = alreadyHave.indexOf(key);

            if (index > -1) {
                alreadyHave.splice(index, 1);
            } else {
                alreadyHave.push(key);
            }

            saveAlreadyHave(alreadyHave);
            updateConsolidatedList();
        }

        // Export to CSV
        function exportCSV() {
            const items = getConsolidatedItems();
            const alreadyHave = loadAlreadyHave();

            let csv = 'Category,Item,Quantity,Already Have\n';
            ['Produce', 'Protein', 'Pantry'].forEach(category => {
                items[category].forEach(item => {
                    const hasIt = alreadyHave.includes(item.key) ? 'Yes' : 'No';
                    csv += `${category},"${item.name}","${item.quantity}",${hasIt}\n`;
                });
            });

            downloadFile(csv, 'shopping-list.csv', 'text/csv');
        }

        // Export to Markdown
        function exportMarkdown() {
            const items = getConsolidatedItems();
            const alreadyHave = loadAlreadyHave();

            let md = '# Shopping List\n\n';
            ['Produce', 'Protein', 'Pantry'].forEach(category => {
                md += `## ${category}\n\n`;
                items[category].forEach(item => {
                    const checkbox = alreadyHave.includes(item.key) ? '[x]' : '[ ]';
                    const displayText = item.quantity ? `${item.name} (${item.quantity})` : item.name;
                    md += `- ${checkbox} ${displayText}\n`;
                });
                md += '\n';
            });

            downloadFile(md, 'shopping-list.md', 'text/markdown');
        }

        // Get consolidated items (helper for exports)
        function getConsolidatedItems() {
            const items = { Produce: [], Protein: [], Pantry: [] };
            ['Produce', 'Protein', 'Pantry'].forEach(category => {
                const section = document.querySelector(`h4:contains('${category}')`);
                if (section) {
                    const ul = section.nextElementSibling;
                    if (ul) {
                        ul.querySelectorAll('li').forEach(li => {
                            const text = li.textContent.trim();
                            const match = text.match(/^(.+?)\s*\((.+?)\)$/);
                            items[category].push({
                                name: match ? match[1].trim() : text,
                                quantity: match ? match[2].trim() : '',
                                key: (match ? match[1].trim() : text).toLowerCase()
                            });
                        });
                    }
                }
            });
            return items;
        }

        // Helper to download a file
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // CSS selector helper
        HTMLElement.prototype.querySelector = function(selector) {
            if (selector.includes(':contains(')) {
                const match = selector.match(/:contains\('([^']+)'\)/);
                if (match) {
                    const text = match[1];
                    return Array.from(this.querySelectorAll('*')).find(el => el.textContent.includes(text));
                }
            }
            return Element.prototype.querySelector.call(this, selector);
        };

        // Check for preselected plan from meal plan page
        function checkPreselection() {
            const preselectPlan = localStorage.getItem('preselect_plan');
            if (preselectPlan) {
                // Clear the preselect flag
                localStorage.removeItem('preselect_plan');

                // Check if this plan isn't already selected
                const savedSelections = loadSelections();
                if (!savedSelections.includes(preselectPlan)) {
                    // Add it to selections
                    savedSelections.push(preselectPlan);
                    saveSelections(savedSelections);

                    // Check the checkbox
                    const checkbox = document.getElementById(`plan-${preselectPlan}`);
                    if (checkbox) checkbox.checked = true;
                }

                // Scroll to the consolidated list after a brief delay
                setTimeout(() => {
                    document.getElementById('consolidated-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            generatePlanCheckboxes();
            checkPreselection();
            updateConsolidatedList();
        });
    </script>

</body>
</html>
